name: CI/CD

# События для запуска workflow
on:
  # Workflow будет запущен на пуш в ветку main или на pull-request в ветку main
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Шаги workflow
jobs:
  # Сборка проекта на Linux
  build:
    # Тип runner'а, который будет использоваться для сборки проекта
    runs-on: ubuntu-latest

    # Шаги workflow сборки проекта
    steps:
      # Клонировать репозиторий на раннер и сделать check-out на коммит, который вызвал workflow
      - uses: actions/checkout@v4
      # Настроить Java 21 для сборки
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
      # Запустить сборку без тестов и с распечаткой ошибок
      - run: mvn clean install -DskipTests -e
  # Тестирование проекта на разных ОС
  test:
    # Запуск тестов только после успешной сборки проекта
    needs: build
    # Тип runner'а, который будет использоваться для тестирования проекта
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    # Шаги workflow сборки проекта
    steps:
      # Клонировать репозиторий на раннер и сделать check-out на коммит, который вызвал workflow
      - uses: actions/checkout@v4
      # Настроить Java 21 для прогона тестов
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
      # Запустить прогон тестов с распечаткой ошибок
      - run: mvn test -e
  # Тестирование проекта на разных ОС
  deploy:
    # Развёртывание приложения только после успешных тестов
    needs: test
    # Тип runner'а, который будет использоваться для тестирования проекта
    runs-on: ubuntu-latest

    # Шаги workflow развёртывания проекта
    steps:
      # Клонировать репозиторий на раннер и сделать check-out на коммит, который вызвал workflow
      - uses: actions/checkout@v4
      # Настроить Java 21 для прогона тестов
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
      # Запустить сервер прямо на раннере (за неимением удалённого хоста для развёртывания)
      - name: Start and test Echo Server
        run: |
          java -jar target/echo-server.jar > server.log 2>&1 &
          SERVER_PID=$!
          sleep 5
          cat server.log
          for i in {1..20}; do
            if curl -sf http://localhost:8080/actuator/health | grep -q UP; then
              break
            fi
            sleep 1
          done
          RESPONSE=$(curl -s http://localhost:8080/hello)
          echo "Response: $RESPONSE"
          if [ "$RESPONSE" != "hello" ]; then
            echo "Server did not respond correctly"
            kill $SERVER_PID
            exit 1
          fi
          kill $SERVER_PID
#      # Развёртывание на удалённом сервере с помощью SSH
#      - name: Deploy to remote server
#        uses: appleboy/ssh-action@v0.1.7
#        with:
#          host: ${{ secrets.REMOTE_HOST }}
#          username: ${{ secrets.REMOTE_USER }}
#          key: ${{ secrets.REMOTE_KEY }}
#          script: |
#            systemctl stop echo-server || true
#            cp /home/deploy/echo-server.jar /opt/echo-server/echo-server.jar
#            systemctl start echo-server
#            curl -s http://localhost:8080/hello
